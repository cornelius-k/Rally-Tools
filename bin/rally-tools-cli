#!/usr/bin/env ruby
# Rally Tools Command Line Interface

require 'optparse'
require 'rally-tools'
require 'json'
require_relative '../lib/rally-deploy/rally_deploy.rb'

# set up options parsing
options = {}
global = OptionParser.new do |opts|

  opts.banner = "Usage: rally-tools-cli [options]"

  opts.on("-h", "--help", "Prints this help message") do
    puts opts
    puts subcommands
  end

  ## Display Rally Tools Configuration
  opts.on("-c", "--config", "Display currently configured rally environment name.") do
    puts RallyTools::get_config()
  end

end

# nested options for individual tools
subcommands = {

  # simple deployment
  'deploy' => OptionParser.new do |opts|

    # deploy an individual file
    opts.on("-f", "--file NAME", "The path to the of the preset to deploy") do |file_path|
      result = RallyDeploy::simple_deploy(file_path)
      p JSON[result]
    end

   end,

   # git deployment
   'git-deploy' => OptionParser.new do |git_opts|

    # run git-deployment without a prompt for machine execution
     git_opts.on("-f", "Run a deployment without any prompt.") do
       puts "Executing Rally Tools git-deployment script..."
       load '../lib/rally-deploy/run_deployment.rb'
     end
   end
 }

# parse ARGV
global.order!

# parse subcommands
if ARGV.size > 0
  subcommands[ARGV.shift].order!
end
